<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Demo</title>
    <link href="../jquery.image-label.css" rel="stylesheet">
</head>
<body>
<button id="btnCreate">新增</button>
<button id="btnSave">保存</button>
<button id="btnShow">隐藏标签</button>
    <div id="kbsArea" class="kbs-area">
        <img src="demo.jpg" style="width:1000px;">
    </div>

    <script src="https://cdn.bootcss.com/jquery/1.12.4/jquery.min.js"></script>
    <script src="https://cdn.bootcss.com/json2/20160511/json2.min.js"></script>
    <script src="../jquery.image-label.js"></script>
    <script>

        var _area = $('#kbsArea');
        //load
        var _arr = JSON.parse(localStorage.getItem('labelArr'));
        $(_arr).each(function(i, item){
            var _labelHtml = '<div _index="' + item.index + '" class="kbs-label kbs-label-arrow kbs-label-arrow-left kbs-label-black kbs-label-' + item.index +  '" draggable="true" style="top:' + item.top + 'px;left:' + item.left + 'px" _top="' + item.top + '" _left="' + item.left + '">' + item.text + '</div>';
            _area.append(_labelHtml);
        });
        //show
        $('#btnShow').click(function(){
            var isShow = $(this).attr('_flag');
            isShow = typeof(isShow)=='undefined'?1:isShow;
            if (isShow && isShow==1){
                $(this).text('展示标签');
                $('.kbs-label').hide();
                $(this).attr('_flag', 0);
            }else{
                $(this).text('隐藏标签');
                $('.kbs-label').show();
                $(this).attr('_flag', 1);
            }
        });
        //hide
        //save
        $('#btnSave').click(function(){
            var _arr = [];
            var _labelArr = _area.find('.kbs-label');
            $(_labelArr).each(function(i, _label){
                console.log(_label)
                var _json = {};
                _json.text = $(_label).html();
                _json.index = $(_label).attr('_index');
                _json.top = $(_label).attr('_top');
                _json.left = $(_label).attr('_left');
                _arr.push(_json);
            });
            localStorage.setItem('labelArr', JSON.stringify(_arr));
        });
        //create
        $('#btnCreate').click(function(){
            var _ind = _area.find('.kbs-label').length;
            _ind++;
            var _class = 'kbs-label-' + _ind;
            var _labelHtml = '<div _index="' + _ind + '" class="kbs-label kbs-label-arrow kbs-label-arrow-left kbs-label-black ' + _class +  '" draggable="true">新建标签_' + _ind + '</div>';
            _area.append(_labelHtml);
            var _top = $('#kbsArea img').get(0).offsetTop + 10;
            var _left = $('#kbsArea img').get(0).offsetLeft + 30;
            var _label = _area.find('.' + _class);
            _label.css({
               top: _top,
               left: _left
            });
            _label.attr('_top', _top);
            _label.attr('_left', _left);
        });
        _area.on({
            'drop': function(e){
                e.preventDefault();
                //if (!$(e.target).hasClass('kbs-label')) return false;

                var dataTransfer = e.dataTransfer || e.originalEvent.dataTransfer;
                var data = dataTransfer.getData("Text");
                if (data!='kbs-drag-active') return false;
                var _label = $('.' + data);
                _label.css({
                    left: e.clientX,
                    top: e.offsetY
                })
                _label.attr('_top', e.offsetY);
                _label.attr('_left', e.clientX);
                $(this).append($('.' + data));
                $('.' + data).removeClass('kbs-drag-active');
            },
            'dragover': function(e){
                e.preventDefault();
            }
        });

        _area.on('dragstart', '.kbs-label', function(e){
            var _this = this;
            $(_this).addClass('kbs-drag-active');
            var dataTransfer = e.dataTransfer || e.originalEvent.dataTransfer;
            dataTransfer.setData("Text", 'kbs-drag-active');
        });
        _area.on('dblclick', '.kbs-label', function(e){
            $(this).prop('contenteditable', true);
        });
        _area.on('blur', '.kbs-label', function(e){
            var _this = this;
            $(this).prop('contenteditable', false);
            if ($(this).text()==''){
                if (window.confirm('确定删除吗')){
                    $(this).remove();
                }
            }
        });

    </script>
</body>
</html>